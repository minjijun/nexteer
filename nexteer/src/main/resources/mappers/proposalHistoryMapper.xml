<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.nexteer.proposalHistory">
	<select id="getProposalHistoryIndex" resultType="Integer">
		select IFNULL(max(proposal_history_index),0)+1
		  from proposal_history
	</select>
	
	<insert id="registerProposalHistory">
		insert into proposal_history(proposal_history_index, proposal_history_suggested_product, company_customer_index, member_index, proposal_history_job, proposal_history_job_date, proposal_history_register_date)
		values (#{proposal_history_index}, #{proposal_history_suggested_product}, #{company_customer_index}, #{member_index}, #{proposal_history_job}, #{proposal_history_job_date}, now())
	</insert>
	
	<insert id="registerProposalHistories" parameterType="java.util.List">
		insert into proposal_history(proposal_history_index, proposal_history_suggested_product, company_customer_index, member_index, proposal_history_job, proposal_history_job_date, proposal_history_register_date)
		values
			<foreach item="item" index="index" collection="list" separator=",">
			    (#{item.proposal_history_index}, #{item.proposal_history_suggested_product}, #{item.company_customer_index}, #{item.member_index}, #{item.proposal_history_job}, #{item.proposal_history_job_date}, now())       
			</foreach>
	</insert>

	<select id="getProposalHistoryList" resultType="kr.co.nexteer.domain.ProposalHistoryVO">
		select *
		  from proposal_history
	</select>
	
	<select id="getProposalHistory" parameterType="Integer" resultType="kr.co.nexteer.domain.ProposalHistoryVO">
		select *
		  from proposal_history
		 where proposal_history_index = #{proposal_history_index}
	</select>
	
	<select id="getProposalHistoryByCompanyCustomerIndex" parameterType="Integer" resultType="kr.co.nexteer.domain.ProposalHistoryVO">
		select proposal_history_suggested_product as proposal_history_suggested_product, p.member_index as member_index, member_name as member_name, company_index as company_index, max(if(proposal_history_job = "제안서 메일 전송", proposal_history_job_date, "")) as proposal_history_job_date1, max(if(proposal_history_job = "견적서 메일 전송", proposal_history_job_date, "")) as proposal_history_job_date2, max(if(proposal_history_job = "통화", proposal_history_job_date, "")) as proposal_history_job_date3
				from proposal_history p, member m, company_customer c
			   where p.member_index = m.member_index
                 and p.company_customer_index = c.company_customer_index
                 and p.company_customer_index = #{company_customer_index}
                 and p.proposal_history_suggested_product = #{proposal_history_suggested_product}
			  group by proposal_history_suggested_product, member_index, company_index, member_name
	</select>
</mapper>